#!/usr/bin/env node

/**
 * Polyfill for the `timeout` command on macOS.
 * Usage: timeout <duration> <command> [args...]
 * Supports duration in seconds (raw number or Xs) or minutes (Xm).
 */

const { spawn } = require("node:child_process");

function parseDuration(val) {
  if (!val) return null;
  const match = /^(\d+(?:\.\d+)?)([sm]?)$/.exec(val);
  if (!match) return null;
  const num = parseFloat(match[1]);
  const unit = match[2];
  if (unit === "m") return num * 60 * 1000;
  return num * 1000; // default to seconds
}

const args = process.argv.slice(2);
if (args.length < 2) {
  console.error("Usage: timeout <duration> <command> [args...]");
  process.exit(1);
}

const durationArg = args[0];
const command = args[1];
const commandArgs = args.slice(2);

const timeoutMs = parseDuration(durationArg);
if (timeoutMs === null) {
  console.error(`Invalid duration: ${durationArg}`);
  process.exit(1);
}

const child = spawn(command, commandArgs, { stdio: "inherit" });

const timer = setTimeout(() => {
  child.kill("SIGTERM");
  // Force kill if it doesn't exit
  setTimeout(() => {
    if (!child.killed) child.kill("SIGKILL");
  }, 1000).unref();
  process.exit(124); // Standard timeout exit code
}, timeoutMs);

child.on("exit", (code, signal) => {
  clearTimeout(timer);
  if (signal) {
    process.exit(128 + 15); // Approximate signal exit code
  } else {
    process.exit(code ?? 1);
  }
});

child.on("error", (err) => {
  clearTimeout(timer);
  console.error(`Failed to start command: ${command}`, err);
  process.exit(127); // Command not found / execution failure
});
